name: Check Status

on:

  push:
    branches:
      - 'bug**'
      - 'bugfix**'
      - 'feature**'
      - 'fix**'
      - 'releases**'
      - 'hotfix**'

    paths-ignore:
    - ".github/workflows/**"

  workflow_dispatch:

jobs:

  sonar:

    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v2

      - name: Sonar
        uses: luizhpriotto/action_images@sonarscannercli-v1.0
        env:
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST: http://sonar.sme.prefeitura.sp.gov.br/

  test:

    runs-on: self-hosted
    needs: [ sonar ]
    steps:
      - name: Delete Container..
        run: if [ ! -z $(docker ps -q --filter "name=terceirizadas-db") ]; then docker rm -f terceirizadas-db; fi

      - name: Preparing Container...
        #Criação do container de banco de dados e copia das variaveis que serão carregadas.
        run: |
          docker run -d --rm --cap-add SYS_TIME --name terceirizadas-db -p 5432 --network python-network -e TZ="America/Sao_Paulo" -e POSTGRES_DB=terceirizadas -e POSTGRES_PASSWORD=adminadmin -e POSTGRES_USER=postgres postgres:11-alpine
          cp /srv/env/terceirizadas .

      - name: Running Python Tests
        uses: prefeiturasp/SME-GithubAction-Images@python38-v1.0
        with:
          command: |
            docker network connect python-network $(hostname)
            export PIPENV_VENV_IN_PROJECT=enabled
            pip install --user pipenv pipenv==2022.4.8
            source terceirizadas
            pipenv install --dev
            echo "################ PYTEST ################"
            pipenv run pytest
            echo "################ FLAKE8 ################"
            pipenv run flake8
